<html>
    <head>
        <% include template/header %>
        <style>
            #reward-description {
                margin-top: 10px;
            }
            #rewards-table .image-col {
                width: 200px;
            }
            #rewards-table .points-col {
                width: 100px;
            }
            #rewards-table .edit-remove-col {
                width: 200px;
            }
        </style>
    </head>
    <body>
        <% include template/navbar %>
        <% include template/jumbotron %>
        
        <div class="container">
            <button class="btn btn-default" id="addbutton">Add a reward</button>
            <div id="addform"></div>
        </div>

        <div class="container">
            <table id="rewards-table" class="table">
            </table>
        </div>

        <% include modules/modal %>
        <% include template/footer %>
    </body>
    <script>
               
        var populateRewardsTable = function (data) {
            if (data.length > 0) {
                var heading = '<tr><th>Image</th><th>Points</th><th>Description</th><th>Edit/Remove</th></tr>';
                $("#rewards-table").append(heading);

                data.forEach(function (reward) {
                    var objectid = reward['objectId'];
                    var imageUrl = reward['image'] ? reward['image'] : 'noimage.jpg';
                    var points = reward['points'];
                    var description = reward['description'];

                    var row = 
                        $('<tr><td class="image-col"><a href="#" class="thumbnail"><img src="img/'+imageUrl+'" alt="'+imageUrl+'"></a></td>'+
                        '<td class="points-col">'+points+'</td>'+
                        '<td class="descrip-col">'+description+'</td>'+
                        '<td class="edit-remove-col">'+
                          '<button type="submit" class="btn btn-primary edit" id="'+objectid+'">Edit</button>'+
                          '<button type="submit" class="btn btn-danger remove" id="'+objectid+'">Remove</button>'+
                          '</td></tr>');
                    row.hide();

                    $('#rewards-table tr:last-child').after(row);
                    row.fadeIn(1000);
                });
            } else {
                $("#rewards-table").append('<td><h3>No available rewards.</h3></td>');
            }
        }

        $('#rewards-table').ready(function() {
            $.get('/rewards/getrewards', populateRewardsTable);
        });

        $('#rewards-table').on('click', '.remove', function() {
            $.post('/rewards/removereward', { objectid: this.id }).done(function() {
                $('#rewards-table').empty();
                $.get('/rewards/getrewards', populateRewardsTable);
            });
        });

        $('#rewards-table').on('click', '.edit', function() {
            var formBody = 
              '<div class="form-group">'+
                '<label for="editDescription" class="control-label">Description:</label>'+
                    '<input type="text" name="description" id="editDescription" class="form-control" placeholder="Description" required>'+
              '</div>'+
              '<div class="form-group">'+
                '<label for="editPoints" class="control-label">Points:</label>'+
                    '<input type="number" name="points" id="editPoints" class="form-control" placeholder="Points" required>'+
              '</div>'+
              '<input type="hidden" name="objectId" value="'+this.id+'">';

            $('#modal-title-text').text('Edit Reward');
            $('#modal-body-div').empty().append(formBody);
            $('#modal-dismiss-text').text('Close');
            $('#modal-submit-text').text('Save Changes');
            $('#modal').modal('show');
        });

        $('#modal-form').submit(function(event) {
          event.preventDefault();
          var data = 
            {
                objectId: $(this).find('input[name="objectId"]').val(),
                description: $(this).find('input[name="description"]').val(),
                points: $(this).find('input[name="points"]').val()
            };

          $.ajax({
            url: '/rewards/editreward',
            type: 'PUT',
            data: data,
            success: function(data) {
              $('#modal').modal('hide');
              $('#modal-body-div').empty();
              $('#rewards-table').empty();
              $.get('/rewards/getrewards', populateRewardsTable);
            }
          });
        });

        $('#addbutton').click(function() {
            var addform = 
            $('<form id="addForm">' +
                '<input type="text" id="name" placeholder="Name">' +
                '<input type="text" id="description" placeholder="Description">' +
                '<input type="number" id="points" placeholder="Points">' +
                '<input type="submit" value="Submit!"></form>');
            $("#addform").append(addform);
        });

        $("#addform").submit(function(event) {
            event.preventDefault();
            var data = 
                {
                    name: $("#name").val(), 
                    description: $("#description").val(), 
                    points: $("#points").val()
                };
            //console.log(data);
            $.post('/rewards/addreward', data);
            $('#rewards-table').empty();
            $.get('/rewards/getrewards', populateRewardsTable);
        });
        

    </script>
</html>
